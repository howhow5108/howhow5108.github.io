<head>
    <title>Document</title>
    <style>
        .send-box {
            display: flex;
            align-items: cemter;
            justify-context: center;
            gap: 16px;
            height: 20%;
        }

        .send-box textarea {
            width: 80%;
            resize: none;
        }

        .send-box .send-btn {
            flex-shrink: 0;
            width: 10%;
            min-width: 32px;
            height: 66px;
        }
    </style>
    <!-- Load the Telegram Library -->
    <script src="https://telegram.org/js/telegram-web-app.js?57"></script>
    <!-- Load the Fabric Library -->
    <script src="https://cdn.jsdelivr.net/npm/fabric@latest/dist/index.min.js"></script>
    <script async src="https://telegram.org/js/telegram-widget.js?22" data-telegram-login="IreneWan730_bot" data-size="medium" data-onauth="onTelegramAuth(user)" data-request-access="write"></script>
    <script type="text/javascript">
        function onTelegramAuth(user) {
            alert('Logged in as ' + user.first_name + ' ' + user.last_name + ' (' + user.id + (user.username ? ', @' + user.username : '') + ')');
            console.log('Logged in as ' + user.first_name + ' ' + user.last_name + ' (' + user.id + (user.username ? ', @' + user.username : '') + ')');
        }
    </script>
</head>
<body>

<canvas id="canvas"
  width="400" 
  height="400" 
  style="border: 1px solid #ccc;"
></canvas>
<div class="send-box">
    <button class="send-btn" id="saveBtn">SEnD</button>
    <button class="send-btn" id="loadBtn">Test</button>
    <button class="send-btn" id="ClearBtn">Clearrrrrrrrr</button>
</div>
<script type="text/javascript">  
    var ws
    var canvas
    const saveBtn = document.querySelector('#saveBtn');    
    const loadBtn = document.querySelector('#loadBtn');
    const clearBtn = document.querySelector('#clearBtn');      
    saveBtn.addEventListener("click", save);
    loadBtn.addEventListener("click", load);
    clearBtn.addEventListener("click", clear);

    function save() {
        /*
        console.log('save')
        sendMsg(ws,{tag: 'save', data: JSON.stringify(canvas)})
        canvas.isDrawingMode = false
        */
        temp = canvas.toDataURL({format: 'png'})
        console.log(temp)        
        window.Telegram.WebApp.sendData(JSON.stringify(
            {
                tag: 'send_pic',
                data: temp
            }
            ));
        
    }

    function load() {
        /*
        console.log('load')
        sendMsg(ws,{tag: 'load', data: JSON.stringify(canvas)})
        */
        temp = canvas.toDataURL({format: 'jpeg'})
        console.log(window.location.search)
        sendMsg(ws,{tag: 'send_img', data: {user: user, img: temp}})
    }

    function clear() {
        console.log('clear')
        console.log(window.location.search)
        canvas.clear();
        sendMsg(ws,{tag: 'clear', data: JSON.stringify(canvas)})
    }

    function mouseUp() {
        if (!canvas.isDrawingMode) {
            return;
        };
        canvas.isDrawingMode = false;
        sendMsg(ws,{tag: 'drawn', data: JSON.stringify(canvas)})
    }

    function connectWebSocket() {
            ws = new WebSocket('wss://howhow5108.camdvr.org:8080');

            ws.onopen = function (event) {
                console.log('WebSocket connected');
                /*
                query = window.location.search
                console.log('asdasdasdasd', window.location)
                urlParams = new URLSearchParams(query);
                user_id = urlParams.get('user_id');
                chat_id = urlParams.get('chat_id');
                console.log(urlParams)
                console.log(user_id, chat_id)
                console.log('456', window.Telegram)
                console.log('123123123', window.Telegram.WebApp)
                */
                console.log('window.location', window.location)
                console.log('window.Telegram', window.Telegram)
                console.log('window.Telegram.WebApp', window.Telegram.WebApp)
                user = window.Telegram.WebApp.initDataUnsafe.user
                chat_id = window.Telegram.WebApp.initDataUnsafe.chat_instance
                sendMsg(ws,{
                    tag: 'connected', data: {user: user, chat_id: chat_id}
                });
                sendMsg(ws,{
                    tag: 'request', data: {user: user, chat_id: chat_id}
                });
            };

            ws.onerror = function (event) {
                console.log(event)
                ws.onclose=function(e){
                    console.log(e)
                };
            };

            ws.onmessage = function (event) {  
                const msg = JSON.parse(event.data);  
                console.log(msg);
                if (msg.tag == 'start') {
                    canvas = new fabric.Canvas('canvas');
                    canvas.backgroundColor = 'white'
                    canvas.requestRenderAll();
                    if (msg.data) {
                        canvas.loadFromJSON(msg.data);
                        canvas.requestRenderAll();
                    };
                    canvas.skipTargetFind = true;
                    canvas.selection = false;
                    canvas.isDrawingMode = true;
                    canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
                    canvas.freeDrawingBrush.width = 5;
                    canvas.on('mouse:up', e => {
                        if (!canvas.isDrawingMode) {                           return;
                        };
                        console.log(e)
                        canvas.isDrawingMode = false;
                        sendMsg(ws,{tag: 'drawn', data: JSON.stringify(canvas)})
                    })
                } else if (msg.tag == 'canvas') {
                    canvas.loadFromJSON(msg.data);
                    canvas.requestRenderAll();
                }
            };

            ws.onclose = function (event) {
                console.log('WebSocket closed',event);
                // reconnect
                setTimeout(connectWebSocket, 1000/2);
            };

        }

    function sendMsg(ws, msg) {
        if (!ws) {
            return;
        }
        ws.send(JSON.stringify(msg));
    }
    connectWebSocket();
</script>
</body>
